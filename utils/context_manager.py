import os
import json
import traceback
from typing import Any
from contextvars import ContextVar
from dotenv import load_dotenv
import openai
import logging

# ============================================================================
# ì´ˆê¸°í™” ë° ì„¤ì •
# ============================================================================

# í™˜ê²½ë³€ìˆ˜ ë¡œë“œ ë° OpenAI ì„¤ì •
load_dotenv()
openai.api_key = os.getenv("OPENAI_API_KEY")

logger = logging.getLogger(__name__)

# ContextVar ê¸°ë°˜ crew ì‹¤í–‰ ì»¨í…ìŠ¤íŠ¸ ê´€ë¦¬
crew_type_var: ContextVar[str] = ContextVar("crew_type", default="unknown")
todo_id_var: ContextVar[str] = ContextVar("todo_id", default=None)
proc_id_var: ContextVar[str] = ContextVar("proc_inst_id", default=None)
form_id_var: ContextVar[str] = ContextVar("form_id", default=None)

def _handle_error(operation: str, error: Exception) -> None:
    """í†µí•© ì—ëŸ¬ ì²˜ë¦¬"""
    error_msg = f"âŒ [{operation}] ì˜¤ë¥˜ ë°œìƒ: {str(error)}"
    print(error_msg)
    print(f"ìƒì„¸ ì •ë³´: {traceback.format_exc()}")
    raise Exception(f"{operation} ì‹¤íŒ¨: {error}")

# ============================================================================
# ì»¨í…ìŠ¤íŠ¸ ê´€ë¦¬
# ============================================================================

def set_crew_context(crew_type: str, todo_id: str = None, proc_inst_id: str = None, form_id: str = None):
    """ContextVarì— crew ì •ë³´ ì„¤ì • ë° í† í° ë°˜í™˜"""
    try:
        token_ct = crew_type_var.set(crew_type)
        token_td = todo_id_var.set(todo_id)
        token_pid = proc_id_var.set(proc_inst_id)
        token_fid = form_id_var.set(form_id)
        return token_ct, token_td, token_pid, token_fid
    except Exception as e:
        _handle_error("ì»¨í…ìŠ¤íŠ¸ì„¤ì •", e)

def reset_crew_context(token_ct, token_td, token_pid, token_fid):
    """ContextVar ì„¤ì •ì„ ì´ì „ ìƒíƒœë¡œ ë³µì›"""
    try:
        crew_type_var.reset(token_ct)
        todo_id_var.reset(token_td)
        proc_id_var.reset(token_pid)
        form_id_var.reset(token_fid)
    except Exception as e:
        _handle_error("ì»¨í…ìŠ¤íŠ¸ë¦¬ì…‹", e)

# ============================================================================
# ìš”ì•½ ì²˜ë¦¬
# ============================================================================

def summarize(outputs: Any, feedbacks: Any) -> str:
    """ì£¼ì–´ì§„ outputsì™€ feedbacksë¥¼ LLMìœ¼ë¡œ ìš”ì•½"""
    try:
        print("\n\nìš”ì•½ì„ ìœ„í•œ LLMí˜¸ì¶œ ì‹œìž‘\n\n")
        
        # ë°ì´í„° ì¤€ë¹„
        outputs_str = _convert_to_string(outputs)
        feedbacks_str = _convert_to_string(feedbacks)
        
        # í”„ë¡¬í”„íŠ¸ ìƒì„± ë° LLM í˜¸ì¶œ
        prompt = _create_summary_prompt(outputs_str, feedbacks_str)
        summary = _call_openai_api(prompt)
        
        print(f"âœ… Context ìš”ì•½ ì™„ë£Œ: {len(summary)}ìž", flush=True)
        return summary
        
    except Exception as e:
        _handle_error("ìš”ì•½ì²˜ë¦¬", e)

def _convert_to_string(data: Any) -> str:
    """ë°ì´í„°ë¥¼ ë¬¸ìžì—´ë¡œ ë³€í™˜"""
    if isinstance(data, str):
        return data
    return json.dumps(data, ensure_ascii=False)

def _create_summary_prompt(outputs_str: str, feedbacks_str: str) -> str:
    """ìš”ì•½ìš© í”„ë¡¬í”„íŠ¸ ìƒì„±"""
    return f"""ìƒˆ ì‚°ì¶œë¬¼ê³¼ í”¼ë“œë°±ì„ ë³‘í•©í•˜ì—¬, ì•„ëž˜ í˜•ì‹ì— ë§žëŠ” í•˜ë‚˜ì˜ í†µí•© ìš”ì•½ì„ ìƒì„±í•˜ì„¸ìš”.

**í•µì‹¬ ì›ì¹™:**
1. **ë³´ê³ ì„œ í˜•ì‹**: ê²°ê³¼ë¬¼ ë‚´ìš©ì´, ë§ˆí¬ë‹¤ìš´ í˜•ì‹ì˜ ë³´ê³ ì„œ ë‚´ìš© -> ëª©ì°¨(ì„¹ì…˜, TOC) ì¶”ì¶œ í›„ ëª©ì°¨(ì„¹ì…˜)ë³„ ìš”ì•½ ì§„í–‰
2. **ë‹¨ìˆœ í…ìŠ¤íŠ¸**: ê·¸ì € ì¼ë°˜ ìš”êµ¬ì‚¬í•­ê³¼ ê°™ì€ í…ìŠ¤íŠ¸ì´ë©´ì„œ, ëª©ì°¨ ì—†ìœ¼ë©´ â†’ ëª©ì +ìš”êµ¬ì‚¬í•­ ì¶”ì¶œ
3. **í”¼ë“œë°±**: í”¼ë“œë°±ì´ ìžˆìœ¼ë©´ â†’ í”¼ë“œë°± ë‚´ìš© í¬í•¨
4. **ëª©ì°¨(ì„¹ì…˜, TOC) ì›ë³¸ ìœ ì§€**: ì„¹ì…˜ëª…ì„ ìžˆëŠ” ê·¸ëŒ€ë¡œ ì¶”ì¶œ, ì™œê³¡ ê¸ˆì§€ (ê°€ìž¥ ì¤‘ìš”!)
5. **í”¼ë“œë°± êµ¬ë¶„**: íŠ¹ì • ì—ì´ì „íŠ¸ ì§€ì •(@@ì—ì´ì „íŠ¸ëª…) vs ì „ì—­ì  í”¼ë“œë°± êµ¬ë¶„
6. **ë¶„ëŸ‰ ì œí•œ**: ì „ì²´ 2000ìž ì´ë‚´
7. **ìˆ˜ì¹˜ ìš°ì„ **: ìˆ«ìž, ë°ì´í„°, êµ¬ì²´ì  ì‚¬ì‹¤ ë°˜ë“œì‹œ í¬í•¨

ðŸ“Œ í”¼ë“œë°± ë¶„ë¥˜ ê¸°ì¤€:
- íŠ¹ì • ì—ì´ì „íŠ¸ ì§€ì •: "@@ì—ì´ì „íŠ¸ëª…ì€ ì´ë ‡ê²Œ í•´ë¼" â†’ í•´ë‹¹ ì—ì´ì „íŠ¸ëª… ëª…ì‹œ
- ì „ì—­ì  í”¼ë“œë°±: "ì´ë ‡ê²Œ ìˆ˜ì •í•´ë¼", "ë” ìžì„¸ížˆ ì¨ë¼" â†’ ì „ì—­ì ìœ¼ë¡œ ë¶„ë¥˜

âš ï¸ í•„ìˆ˜: 
1. ëª©ì°¨ëª…(ì„¹ì…˜)ëŠ” ì›ë³¸ ê·¸ëŒ€ë¡œ, ìˆ˜ì¹˜ ë°ì´í„° ìš°ì„ , 2000ìž ì´ë‚´ (ëª©ì°¨ ëª… ì™œê³¡ ë° ìˆ˜ì • ê¸ˆì§€)
2. ì—†ëŠ” ëª©ì°¨(ì„¹ì…˜)ë¥¼ í”¼ë“œë°±ì„ ë³´ê³  ìƒì„±í•˜ì§€ë§ê³ , ìžˆëŠ” ê·¸ëŒ€ë¡œ ëª©ì°¨(ì„¹ì…˜)ë¥¼ ì¶”ì¶œí•˜ê³ , í”¼ë“œë°±ì€ ê°™ì´ ì „ë‹¬ë˜ë‹ˆê¹Œ í˜„ìž¬ ë‹¨ê³„ì—ì„œ ë°˜ì˜í•˜ì§€ ì•Šì•„ë„ ë©ë‹ˆë‹¤.
3. ê²°ê³¼ë¬¼ ë‚´ìš©ì— ëª…í™•ížˆ ëª©ì°¨(ì„¹ì…˜)ê°€ ì‹ë³„ëœ êµ¬ì¡°í™”ëœ ë³´ê³ ì„œ í˜•ì‹ì˜ ë‚´ìš©ì¼ ê²½ìš°ì—ë§Œ ëª©ì°¨(ì„¹ì…˜) ì¶”ì¶œ í›„ ëª©ì°¨ë³„ ìš”ì•½ ì§„í–‰
4. ëª©ì°¨(ì„¹ì…˜)ê°€ ì—†ìœ¼ë©´ ê·¸ëƒ¥ "ì—†ìŒ"ìœ¼ë¡œ ì²˜ë¦¬
5. ê²°ê³¼ë¬¼ì€ ë°˜ë“œì‹œ ê·¸ì € ìš”ì•½ ë° í•µì‹¬ ì •ë³´ ì¶”ì¶œì¼ ë¿ìž…ë‹ˆë‹¤. í”¼ë“œë°±ì„ ë°˜ì˜í•˜ëŠ”ê²Œ ì•„ë‹™ë‹ˆë‹¤.
6. ì „ë‹¬ëœ ê°’ì€ ì‚¬ì „ í˜•íƒœë¡œ, ì¤‘ì²©ëœ êµ¬ì¡°ìž…ë‹ˆë‹¤. ì˜¤ë¡œì§ ê°’ì„ ê¸°ì¤€ìœ¼ë¡œ ëª©ì°¨ë¥¼ ì˜ë¯¸ì ìœ¼ë¡œ íŒŒì•…í•´ì„œ ì¶”ì¶œí•˜ì„¸ìš”. ë‹¨ìˆœížˆ í‚¤ë¥¼ ëª©ì°¨ë¡œ ë‘ë©´ ì•ˆë©ë‹ˆë‹¤.(ë³´í†µ í‚¤ëŠ” ì˜ë¬¸ìžë¡œ ë˜ì–´ìžˆìŒ)

**ê²°ê³¼ë¬¼ ë‚´ìš©:** {outputs_str}
**í”¼ë“œë°± ë‚´ìš©:** {feedbacks_str}

===== ìš”ì•½ í˜•ì‹ (ë°˜ë“œì‹œ ì´ í˜•ì‹ì„ ë”°ë¥´ì„¸ìš”) =====

ðŸ“Œ ëª©ì  : [ê²°ê³¼ë¬¼ ë‚´ìš©ì„ ë¶„ì„í•˜ì—¬ ëª©ì ì„ ì •ì˜]
ðŸ“Œ ìš”êµ¬ì‚¬í•­ : [ê²°ê³¼ë¬¼ ë‚´ìš©ì„ ë¶„ì„í•˜ì—¬ ìš”êµ¬ì‚¬í•­ì„ ì •ì˜]
ðŸ“Œ í”¼ë“œë°± : [í”¼ë“œë°± ë‚´ìš©ì„ ë¶„ì„í•˜ì—¬ í”¼ë“œë°±ì„ ì •ì˜]

ðŸ“‹ ë³´ê³ ì„œ ì œëª©: [ì •í™•ížˆ ì¶”ì¶œí•œ ì œëª© ì—†ìœ¼ë©´, ë¬¸ë§¥ìƒ íë¦„ì„ ë¶„ì„í•˜ì—¬ ì œëª©ì„ ì •ì˜]

ðŸŽ¯ ëª©ì°¨ë³„ í•µì‹¬ ìš”ì•½:

1ï¸âƒ£ [ëª©ì°¨1 ì œëª©]:
   â€¢ í•µì‹¬ë‚´ìš© 1: [ì¤‘ìš” í¬ì¸íŠ¸ë¥¼ í•œ ë¬¸ìž¥ìœ¼ë¡œ]
   â€¢ í•µì‹¬ë‚´ìš© 2: [ì£¼ìš” ë°ì´í„°ë‚˜ ê²°ê³¼ë¥¼ í•œ ë¬¸ìž¥ìœ¼ë¡œ]
   â€¢ í•µì‹¬ë‚´ìš© 3: [ê²°ë¡ ì´ë‚˜ ì‹œì‚¬ì ì„ í•œ ë¬¸ìž¥ìœ¼ë¡œ]

2ï¸âƒ£ [ëª©ì°¨2 ì œëª©]:
   â€¢ í•µì‹¬ë‚´ìš© 1: [ì¤‘ìš” í¬ì¸íŠ¸ë¥¼ í•œ ë¬¸ìž¥ìœ¼ë¡œ]
   â€¢ í•µì‹¬ë‚´ìš© 2: [ì£¼ìš” ë°ì´í„°ë‚˜ ê²°ê³¼ë¥¼ í•œ ë¬¸ìž¥ìœ¼ë¡œ]
   â€¢ í•µì‹¬ë‚´ìš© 3: [ê²°ë¡ ì´ë‚˜ ì‹œì‚¬ì ì„ í•œ ë¬¸ìž¥ìœ¼ë¡œ]

3ï¸âƒ£ [ëª©ì°¨3 ì œëª©]:
   â€¢ í•µì‹¬ë‚´ìš© 1: [ì¤‘ìš” í¬ì¸íŠ¸ë¥¼ í•œ ë¬¸ìž¥ìœ¼ë¡œ]
   â€¢ í•µì‹¬ë‚´ìš© 2: [ì£¼ìš” ë°ì´í„°ë‚˜ ê²°ê³¼ë¥¼ í•œ ë¬¸ìž¥ìœ¼ë¡œ]
   â€¢ í•µì‹¬ë‚´ìš© 3: [ê²°ë¡ ì´ë‚˜ ì‹œì‚¬ì ì„ í•œ ë¬¸ìž¥ìœ¼ë¡œ]

[ê³„ì†í•´ì„œ ëª¨ë“  ëª©ì°¨ì— ëŒ€í•´ ë™ì¼í•œ í˜•ì‹ìœ¼ë¡œ...]"""

def _get_system_prompt() -> str:
    """ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ ë°˜í™˜"""
    return """ë‹¹ì‹ ì€ ì „ë¬¸ì ì¸ ìš”ì•½ ì „ë¬¸ê°€ìž…ë‹ˆë‹¤.

ì£¼ìš” ì—­í• :
- ë³µìž¡í•œ ì‚°ì¶œë¬¼(ë³´ê³ ì„œ, í¼ ë“±)ì„ êµ¬ì¡°í™”ëœ í˜•ì‹ìœ¼ë¡œ ì •í™•ížˆ ìš”ì•½
- ëª©ì°¨ë³„ í•µì‹¬ ë‚´ìš©ì„ ë¹ ì§ì—†ì´ ì¶”ì¶œ
- ë©”íƒ€ë°ì´í„°ì™€ ì¤‘ìš” ë°ì´í„°ë¥¼ ì •í™•ížˆ íŒŒì•…
- ë¹„ì¦ˆë‹ˆìŠ¤ ë¬¸ì„œì˜ í•µì‹¬ ê°€ì¹˜ë¥¼ ë³´ì¡´í•˜ë©´ì„œ ê°„ê²°í•˜ê²Œ ì •ë¦¬

ìž‘ì—… ì›ì¹™:
1. ì •í™•ì„±: ì›ë¬¸ì˜ ë‚´ìš©ì„ ì™œê³¡í•˜ì§€ ì•Šê³  ì •í™•ížˆ ìš”ì•½
2. ì™„ì „ì„±: ëª¨ë“  ëª©ì°¨ì™€ ì¤‘ìš” ì •ë³´ë¥¼ ëˆ„ë½ ì—†ì´ í¬í•¨
3. êµ¬ì¡°í™”: ì¼ê´€ëœ í˜•ì‹ìœ¼ë¡œ ì½ê¸° ì‰½ê²Œ ì •ë¦¬
4. ê°„ê²°ì„±: í•µì‹¬ë§Œ ì¶”ì¶œí•˜ì—¬ íš¨ìœ¨ì ìœ¼ë¡œ ì „ë‹¬
5. ì‹¤ìš©ì„±: í›„ì† ìž‘ì—…ì— í™œìš©í•˜ê¸° ì‰¬ìš´ í˜•íƒœë¡œ ê°€ê³µ"""

def _call_openai_api(prompt: str) -> str:
    """OpenAI API í˜¸ì¶œ"""
    response = openai.chat.completions.create(
        model="gpt-4.1",
        messages=[
            {"role": "system", "content": _get_system_prompt()},
            {"role": "user", "content": prompt}
        ],
        max_tokens=3000,
        temperature=0.1
    )
    return response.choices[0].message.content.strip()